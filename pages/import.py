import streamlit as st
import os
from utils.database import import_employees_from_csv

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(
    page_title="–ò–º–ø–æ—Ä—Ç - StarLine Reports GUI",
    page_icon="üì•",
    layout="wide"
)

st.title("üì• –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö")

st.info("""
–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ CSV —Ñ–∞–π–ª–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
–í –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∏–º–ø–æ—Ä—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.
""")

# –ò–º–ø–æ—Ä—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
st.header("üë• –ò–º–ø–æ—Ä—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤")

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è CSV —Ñ–∞–π–ª–æ–≤
csv_files = []
base_dir = os.path.dirname(os.path.dirname(__file__))
for file in os.listdir(base_dir):
    if file.endswith('.csv'):
        csv_files.append(file)

if csv_files:
    st.write("**–î–æ—Å—Ç—É–ø–Ω—ã–µ CSV —Ñ–∞–π–ª—ã:**")
    for file in csv_files:
        st.write(f"‚Ä¢ `{file}`")
    
    # –í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
    selected_file = st.selectbox(
        "–í—ã–±–µ—Ä–∏—Ç–µ CSV —Ñ–∞–π–ª –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:",
        csv_files,
        help="–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–ª–æ–Ω–∫–∏ 'id_employee' –∏ 'fio_employee'"
    )
    
    # –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–∞
    if selected_file:
        file_path = os.path.join(base_dir, selected_file)
        try:
            with open(file_path, 'r', encoding='utf-8-sig') as f:
                first_lines = f.readlines()[:5]  # –ü–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫
            
            st.subheader("üìã –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–∞")
            st.code(''.join(first_lines), language="text")
            
            # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ
            file_size = os.path.getsize(file_path)
            st.write(f"**–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:** {file_size / 1024:.1f} KB")
            
        except Exception as e:
            st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: {e}")
    
    # –ö–Ω–æ–ø–∫–∞ –∏–º–ø–æ—Ä—Ç–∞
    if st.button("üöÄ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤", type="primary"):
        if selected_file:
            try:
                with st.spinner("–ò–º–ø–æ—Ä—Ç–∏—Ä—É—é —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤..."):
                    count = import_employees_from_csv(selected_file)
                
                if count > 0:
                    st.success(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ/–æ–±–Ω–æ–≤–ª–µ–Ω–æ {count} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤")
                else:
                    st.warning("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.")
                    
            except Exception as e:
                st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ: {e}")
        else:
            st.warning("‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞")
else:
    st.warning("‚ö†Ô∏è CSV —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞")
    st.write("""
    **–î–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:**
    1. –ü–æ–º–µ—Å—Ç–∏—Ç–µ CSV —Ñ–∞–π–ª –≤ –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
    2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–ª–æ–Ω–∫–∏:
       - `id_employee` - ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (—á–∏—Å–ª–æ)
       - `fio_employee` - –§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (—Ç–µ–∫—Å—Ç)
    3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–¥–∏—Ä–æ–≤–∫—É UTF-8
    """)

# –§–æ—Ä–º–∞—Ç CSV —Ñ–∞–π–ª–∞
st.header("üìã –§–æ—Ä–º–∞—Ç CSV —Ñ–∞–π–ª–∞")
st.write("""
**–ü—Ä–∏–º–µ—Ä CSV —Ñ–∞–π–ª–∞ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:**
```csv
id_employee,fio_employee
1001,–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á
1002,–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á
1003,–°–∏–¥–æ—Ä–æ–≤ –°–∏–¥–æ—Ä –°–∏–¥–æ—Ä–æ–≤–∏—á
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–∞–π–ª—É:**
- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: –∑–∞–ø—è—Ç–∞—è (,)
- –ö–æ–¥–∏—Ä–æ–≤–∫–∞: UTF-8
- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫
- –ö–æ–ª–æ–Ω–∫–∞ `id_employee`: —á–∏—Å–ª–æ–≤–æ–π ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
- –ö–æ–ª–æ–Ω–∫–∞ `fio_employee`: –§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (—Ç–µ–∫—Å—Ç)
""")

# –†—É—á–Ω–æ–π –≤–≤–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
st.header("‚úèÔ∏è –†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞")
st.info("–î–æ–±–∞–≤—å—Ç–µ –æ–¥–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É")

with st.form("add_employee_form"):
    emp_id = st.number_input("ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞", min_value=1, step=1)
    emp_fio = st.text_input("–§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞", placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò.")
    
    submitted = st.form_submit_button("‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞")
    
    if submitted and emp_fio.strip():
        try:
            from utils.database import get_engine
            from sqlalchemy import text
            
            engine = get_engine()
            with engine.begin() as conn:
                conn.execute(text(
                    "INSERT INTO employees(id, fio) VALUES (:id,:fio) ON CONFLICT (id) DO UPDATE SET fio=EXCLUDED.fio"
                ), {"id": emp_id, "fio": emp_fio.strip()})
            
            st.success(f"‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ {emp_fio} (ID: {emp_id}) –¥–æ–±–∞–≤–ª–µ–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω")
            
        except Exception as e:
            st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: {e}")
    elif submitted:
        st.warning("‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞")

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–º–ø–æ—Ä—Ç–∞
st.header("‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–º–ø–æ—Ä—Ç–µ")
st.info("""
**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–º–ø–æ—Ä—Ç:**
1. **–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞** - —Å–∏—Å—Ç–µ–º–∞ —á–∏—Ç–∞–µ—Ç CSV —Ñ–∞–π–ª —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π UTF-8
2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–æ–∫** - –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å
4. **–í—Å—Ç–∞–≤–∫–∞ –≤ –ë–î** - –¥–∞–Ω–Ω—ã–µ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (ON CONFLICT)

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤:**
- –ï—Å–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å —Ç–∞–∫–∏–º ID —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –µ–≥–æ –§–ò–û
- –ï—Å–ª–∏ ID –Ω–æ–≤—ã–π, —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –ø–æ–¥—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è
- –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏
""")
